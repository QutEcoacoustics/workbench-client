<h2>Add New Annotations</h2>

<form #ngForm="ngForm">
  <div class="annotationsimportInput">
    <div class="import-groups">
      <label for="annotationsFileInput" class="form-label required">
        Annotation File(s)
      </label>
      <input
        #fileInput
        id="annotationsFileInput"
        type="file"
        accept=".csv, .tsv, .selections.txt, .json"
        class="form-control border"
        [ngClass]="{ 'is-invalid': !ngForm.valid }"
        [disabled]="uploading"
        (change)="handleFileChange($event)"
        multiple
      />

      <section class="file-list mt-2">
        @if(hasFiles) {
        <ol>
          @for (fileModel of importFiles$ | async; track file) {
          <li class="file-list-item">
            <div class="file-list-item-content">
              <span>
                <button
                  class="remove-btn btn btn-sm btn-outline-danger me-1"
                  (click)="removeBufferedFile(fileModel)"
                >
                  <fa-icon [icon]="['fas', 'xmark']"></fa-icon>
                </button>

                <span>{{ fileModel.file.name }}</span>
              </span>

              <baw-error-card
                [errors]="fileModel.errors"
                [errorStyle]="errorCardStyles.Inline"
                [showSuccessState]="true"
                class="file-errors"
              >
                <!--
                  Because we are inside the file list, there is no need to
                  specify the error keys as all of the errors will be referring
                  to the file in the list item.
                -->
                <ng-template let-value="value">
                  {{ value }}
                </ng-template>
              </baw-error-card>

              <div>
                <baw-typeahead-input
                  class="additional-file-tags"
                  inputPlaceholder="Add tags"
                  [searchCallback]="tagsApi.typeaheadCallback()"
                  [resultTemplate]="tagsTypeaheadTemplate"
                  [inputDisabled]="uploading"
                  (modelChange)="
                    updateFileAdditionalTagIds(
                      fileModel,
                      getIdsFromAbstractModelArray($event)
                    )
                  "
                ></baw-typeahead-input>
              </div>
            </div>
          </li>
          }
        </ol>
        } @else {
        <ng-container [ngTemplateOutlet]="noFilesTemplate"></ng-container>
        }
      </section>

      <div class="mt-2">
        <baw-typeahead-input
          id="additional-tags-input"
          label="Extra Tags"
          [inputPlaceholder]="'search for tags by name'"
          [searchCallback]="tagsApi.typeaheadCallback()"
          [resultTemplate]="tagsTypeaheadTemplate"
          [inputDisabled]="uploading"
          (modelChange)="
            updateExtraTags(getIdsFromAbstractModelArray($event))
          "
        ></baw-typeahead-input>

        <p class="text-muted">
          Extra tags will be applied to all files in the annotation import.
        </p>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-end">
    <!-- we use attr.ngbTooltip because we want to conditionally add a tooltip -->
    <span
      class="d-inline-block mt-2"
      [ngbTooltip]="uploadTooltip"
      [attr.ngbTooltip]="uploadTooltip !== null"
    >
      <button
        id="import-btn"
        type="submit"
        class="btn btn-primary"
        [disabled]="!canCommitUploads"
        (click)="commitImports()"
      >
        Import Annotations
      </button>
    </span>
  </div>
</form>

<hr />

<div class="identified-annotations mt-4">
  <h4>Identified Events</h4>
  <p>
    The following events have been identified in your dataset, but have not been
    saved.
  </p>

  <p>
    You can review these events before saving them with the "Import Annotations"
    button.
  </p>

  <div>
    <ngx-datatable
      bawDatatableDefaults
      [bawVirtualDatatablePagination]="getEventModels"
    >
      <ngx-datatable-column [sortable]="false" prop="id">
        <ng-template let-column="column" ngx-datatable-header-template>
          <span
            class="text-decoration-underline"
            ngbTooltip="File index and the index of the event in the file"
            container="body"
          >
            ID
          </span>
        </ng-template>

        <ng-template let-value="value" ngx-datatable-cell-template>
          0:0
        </ng-template>
      </ngx-datatable-column>

      <ngx-datatable-column [sortable]="false" prop="">
        <ng-template let-column="column" ngx-datatable-header-template>
          Recording
        </ng-template>

        <ng-template let-value="value" ngx-datatable-cell-template>
          @if (!hasRecordingErrors(value)) {
          <baw-loading
            *ngIf="
              value.audioRecording | isUnresolved;
              else audioRecordingTemplate
            "
            size="sm"
          ></baw-loading>

          <ng-template #audioRecordingTemplate>
            <a [bawUrl]="value.audioRecording.viewUrl">
              {{ value.audioRecording.id }}
            </a>
          </ng-template>
          } @else {
          <strong
            class="d-flex align-items-center text-danger font-semibold"
            ngbTooltip="This field contains an error. See errors for more information."
          >
            <fa-icon [icon]="['fas', 'xmark-circle']" class="me-1"></fa-icon>
            <span class="text-decoration-underline">Error</span>
          </strong>
          }
        </ng-template>
      </ngx-datatable-column>

      <ngx-datatable-column [sortable]="false" prop="startTimeSeconds">
        <ng-template let-column="column" ngx-datatable-header-template>
          Start Time
        </ng-template>

        <ng-template let-value="value" ngx-datatable-cell-template>
          <ng-container *ngIf="value; else missingTemplate">
            {{ value | number }}
          </ng-container>
        </ng-template>
      </ngx-datatable-column>

      <ngx-datatable-column [sortable]="false" prop="endTimeSeconds">
        <ng-template let-column="column" ngx-datatable-header-template>
          End Time
        </ng-template>

        <ng-template let-value="value" ngx-datatable-cell-template>
          <ng-container *ngIf="value; else missingTemplate">
            {{ value | number }}
          </ng-container>
        </ng-template>
      </ngx-datatable-column>

      <ngx-datatable-column [sortable]="false" prop="lowFrequencyHertz">
        <ng-template let-column="column" ngx-datatable-header-template>
          Low Frequency
        </ng-template>

        <ng-template let-value="value" ngx-datatable-cell-template>
          <ng-container *ngIf="value; else missingTemplate">
            {{ value | number }}
          </ng-container>
        </ng-template>
      </ngx-datatable-column>

      <ngx-datatable-column [sortable]="false" prop="highFrequencyHertz">
        <ng-template let-column="column" ngx-datatable-header-template>
          High Frequency
        </ng-template>

        <ng-template let-value="value" ngx-datatable-cell-template>
          <ng-container *ngIf="value; else missingTemplate">
            {{ value | number }}
          </ng-container>
        </ng-template>
      </ngx-datatable-column>

      <ngx-datatable-column [sortable]="false" prop="channel">
        <ng-template let-column="column" ngx-datatable-header-template>
          Channel
        </ng-template>

        <ng-template let-value="value" ngx-datatable-cell-template>
          <ng-container *ngIf="value; else missingTemplate">
            {{ value | number }}
          </ng-container>
        </ng-template>
      </ngx-datatable-column>

      <ngx-datatable-column [sortable]="false" prop="duration">
        <ng-template let-column="column" ngx-datatable-header-template>
          Duration
        </ng-template>

        <ng-template let-value="value" ngx-datatable-cell-template>
          <ng-container *ngIf="value; else missingTemplate">
            {{ value | number }}
          </ng-container>
        </ng-template>
      </ngx-datatable-column>

      <ngx-datatable-column [sortable]="false" prop="isReference">
        <ng-template let-column="column" ngx-datatable-header-template>
          Reference
        </ng-template>

        <ng-template let-value="value" ngx-datatable-cell-template>
          <ng-container *ngIf="value; else missingTemplate">
            {{ value }}
          </ng-container>
        </ng-template>
      </ngx-datatable-column>

      <ngx-datatable-column [sortable]="false" prop="score">
        <ng-template let-column="column" ngx-datatable-header-template>
          Score
        </ng-template>

        <ng-template let-value="value" ngx-datatable-cell-template>
          <ng-container *ngIf="value; else missingTemplate">
            {{ value | number }}
          </ng-container>
        </ng-template>
      </ngx-datatable-column>

      <ngx-datatable-column [sortable]="false" prop="tags">
        <ng-template let-column="column" ngx-datatable-header-template>
          Tags
        </ng-template>

        <ng-template let-value="value" ngx-datatable-cell-template>
          <baw-inline-list
            [items]="value"
            [itemKey]="'text'"
            [emptyTemplate]="noAssociatedTagsTemplate"
          ></baw-inline-list>
        </ng-template>
      </ngx-datatable-column>

      <ngx-datatable-column [sortable]="false" [minWidth]="300" prop="errors">
        <ng-template let-column="column" ngx-datatable-header-template>
          Errors
        </ng-template>

        <ng-template let-value="value" ngx-datatable-cell-template>
          <baw-error-card
            [errors]="value"
            [errorStyle]="errorCardStyles.Inline"
            [showSuccessState]="true"
            class="event-errors"
          ></baw-error-card>
        </ng-template>
      </ngx-datatable-column>
    </ngx-datatable>
  </div>
</div>

<ng-template #tagsTypeaheadTemplate let-result="result" let-searchTerm="term">
  <ngb-highlight [result]="result.text" [term]="searchTerm"></ngb-highlight>
</ng-template>

<ng-template #noAssociatedTagsTemplate>
  <span class="text-muted">Empty</span>
</ng-template>

<ng-template #noAdditionalTagsTemplate>
  <span>No additional tags</span>
</ng-template>

<ng-template #defaultDescription>
  <i>No description found</i>
</ng-template>

<ng-template #noFilesTemplate>
  <span class="text-muted">No files found</span>
</ng-template>

<ng-template #missingTemplate>
  <strong
    class="d-flex align-items-center text-warning font-semibold"
    ngbTooltip="This field is could not be found in the uploaded file"
  >
    <fa-icon [icon]="['fas', 'exclamation-triangle']" class="me-1"></fa-icon>
    <span class="text-decoration-underline">Missing</span>
  </strong>
</ng-template>
