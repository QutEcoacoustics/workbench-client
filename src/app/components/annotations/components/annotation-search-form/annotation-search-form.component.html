<form #form="ngForm">
  <baw-date-time-filter
    [(model)]="recordingDateTimeFilters"
    (modelChange)="updateRecordingDateTime($event)"
    [disableStartDate]="true"
    [disableStartTime]="true"
    [disableEndTime]="true"
  ></baw-date-time-filter>

  <baw-typeahead-input
    id="tags-input"
    label="Tags of Interest"
    inputPlaceholder="All"
    [searchCallback]="tagsApi.typeaheadCallback()"
    [resultTemplate]="tagsTypeaheadTemplate"
    [value]="searchParameters.tagModels"
    (modelChange)="updateSubModel('tags', $event)"
  ></baw-typeahead-input>

  <baw-typeahead-input
    id="projects-input"
    label="Project(s)"
    [inputPlaceholder]="project ? project.name : 'All'"
    [searchCallback]="
      createSearchCallback(projectsApi, 'name', this.routeModelFilters())
    "
    [resultTemplate]="nameTypeaheadTemplate"
    [inputDisabled]="!!project"
    (modelChange)="updateSubModel('projects', $event)"
  ></baw-typeahead-input>

  <!-- We disable the input and use a placeholder value if the form is immutably scoped to a region/site -->
  @if (!site || site?.isPoint) {
    <baw-typeahead-input
      id="region-input"
      label="Site(s)"
      [inputPlaceholder]="region ? region.name : 'All'"
      [searchCallback]="
        createSearchCallback(regionsApi, 'name', this.routeModelFilters())
      "
      [resultTemplate]="nameTypeaheadTemplate"
      [inputDisabled]="!!region"
      (modelChange)="updateSubModel('regions', $event)"
    ></baw-typeahead-input>
  }

  <baw-typeahead-input
    id="sites-input"
    [label]="site ? (site?.isPoint ? 'Point(s)' : 'Site(s)') : 'Point(s)'"
    [inputPlaceholder]="site ? site.name : 'All'"
    [searchCallback]="
      createSearchCallback(sitesApi, 'name', this.routeModelFilters())
    "
    [resultTemplate]="nameTypeaheadTemplate"
    [inputDisabled]="!!site"
    (modelChange)="updateSubModel('sites', $event)"
  ></baw-typeahead-input>

  <div>
    <div class="row">
      <div class="col-md-6 mb-2 mb-md-0">
        <label class="input-group">
          <span
            class="input-group-text tooltip-hint"
            [ngbTooltip]="
              'Applying this filter will cause all events without a score to be hidden.'
            "
          >
            Minimum Score
          </span>
          <input
            bawDebouncedInput
            id="lower-score-input"
            type="number"
            class="form-control"
            placeholder="-Infinity"
            step="0.01"
            [value]="searchParameters.score?.[0]"
            (valueChange)="updateScoreRange($event, scoreRangeBounds.Lower)"
          />
        </label>
      </div>

      <div class="col-md-6">
        <label class="input-group">
          <span
            class="input-group-text tooltip-hint"
            [ngbTooltip]="
              'Applying this filter will cause all events without a score to be hidden.'
            "
          >
            Maximum Score
          </span>
          <input
            bawDebouncedInput
            id="upper-score-input"
            type="number"
            class="form-control"
            placeholder="Infinity"
            step="0.01"
            [value]="searchParameters.score?.[1]"
            (valueChange)="updateScoreRange($event, scoreRangeBounds.Upper)"
          />
        </label>
      </div>
    </div>

    @if (scoreRangeError() !== null) {
      <p id="score-errors">
        <strong class="fw-normal text-danger">{{ scoreRangeError() }}</strong>
      </p>
    }
  </div>

  <baw-wip>
    <div class="form-check mt-2">
      <!--
        Because the verifications endpoint is not available yet, we cannot
        filter by verified annotations. This is a placeholder for future
        functionality.
      -->
      <input
        id="filter-verified"
        type="checkbox"
        class="form-check-input"
        [checked]="searchParameters.onlyUnverified"
        (change)="updateParameterProperty('onlyUnverified', $event.target['checked'])"
      />
      <label for="filter-verified" class="form-check-label">
        Only show un-verified annotations
      </label>
    </div>
  </baw-wip>

  <div class="advanced-filters mt-2">
    <button
      id="advanced-filters-toggle"
      class="btn btn-outline-secondary w-100"
      (click)="toggleAdvancedFilters()"
    >
      {{ hideAdvancedFilters ? "Show" : "Hide" }} Advanced Filters
    </button>

    <div
      #advancedFilters="ngbCollapse"
      [(ngbCollapse)]="hideAdvancedFilters"
      class="card card-body border-top-0"
    >
      <baw-typeahead-input
        #recordingsTypeahead
        id="recordings-input"
        label="Recording IDs of interest"
        inputPlaceholder="All"
        [searchCallback]="createIdSearchCallback(recordingsApi, 'id')"
        [resultTemplate]="idTypeaheadTemplate"
        [value]="searchParameters.audioRecordingModels"
        (modelChange)="updateSubModel('audioRecordings', $event)"
      ></baw-typeahead-input>
    </div>
  </div>

  <label class="form-label mt-2 w-100">
    Sort by
    <select
      id="sort-input"
      class="form-select"
      placeholder="Created Date (Oldest First)"
      [value]="searchParameters.sort ?? 'created-asc'"
      (change)="updateSortBy($event)"
    >
      <option value="created-asc">Created Date (Oldest First)</option>
      <option value="created-desc">Created Date (Newest First)</option>

      <option value="score-asc">Score (Ascending)</option>
      <option value="score-desc">Score (Descending)</option>
    </select>
  </label>
</form>

<ng-template #idTypeaheadTemplate let-result="result" let-searchTerm="term">
  <ngb-highlight [result]="result.id" [term]="searchTerm"></ngb-highlight>
</ng-template>

<ng-template #nameTypeaheadTemplate let-result="result" let-searchTerm="term">
  <ngb-highlight [result]="result.name" [term]="searchTerm"></ngb-highlight>
</ng-template>

<ng-template #tagsTypeaheadTemplate let-result="result" let-searchTerm="term">
  <ngb-highlight [result]="result.text" [term]="searchTerm"></ngb-highlight>
</ng-template>
