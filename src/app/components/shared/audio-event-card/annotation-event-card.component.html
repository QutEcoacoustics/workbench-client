<div class="card-container card p-2">
  <div class="spectrogram-container">
    @defer (on viewport) {
      <!--
        Use the same spectrogram settings that the baw-server uses for spectrograms
        so that there is consistency across the website.
        see: QutEcoacoustics/baw-server > config/settings/default.yml#L243-L244
      -->
      <oe-axes class="axes">
        <oe-indicator>
          <oe-spectrogram
            #spectrogram
            [src]="annotation().audioLink"
            scaling="stretch"
            color-map="grayscale"
            window-size="512"
            window-function="hamming"
          />
        </oe-indicator>
      </oe-axes>
    } @placeholder {
      <div class="spectrogram-placeholder"></div>
    }
  </div>

  <div class="card-header">
    <oe-media-controls #mediaControls />
  </div>

  <div class="card-body">
    <span class="info-line tag-information">
      @if (tagInfo().length > 0) {
        @for (tag of tagInfo(); track tag.id; let isLast = $last) {
          <div
            class="tag-item"
            [ngbTooltip]="tagVerifications"
            [tooltipContext]="{ verificationSummary: tag.verificationStatus }"
          >
            <fa-icon class="me-2" [icon]="['fas', 'tags']" />

            <!--
              We show a check or a cross icon depending on if this tag has been
              confirmed as "correct" or "incorrect".
              However, we require a consensus ratio of over 66% to show these
              so that we only show this verified tick if there is strong
              agreement.

              I have chosen 66% so that if there is a disagreement between 2
              verifiers who have opposing opinions, we do not show an icon.
              However, a third verifier can break the tie to show a verified icon
              because this will cause a 2/3 consensus (66.66...%).

              Additionally, if there are 5 verifiers, a 4-1 vote will also show
              a verified icon (80% consensus), but a 3-2 vote (60% consensus)
              will not show an icon (which seems reasonable).

              TODO: I'm sure there's some UX research on what consensus ratio
              is appropriate to show verification ticks, however, I have not
              looked for this research yet.
            -->
            @if (tag.verificationStatus.consensus.ratio > 0.66) {
              @switch (tag.verificationStatus.consensus.decision) {
                @case ("correct") {
                  <span class="me-1 text-success">
                    <fa-icon [icon]="['fas', 'circle-check']" />
                  </span>
                }

                @case ("incorrect") {
                  <span class="me-1 text-danger">
                    <fa-icon [icon]="['fas', 'circle-xmark']" />
                  </span>
                }
              }
            }
            <!--
              we use a non-breaking space here so that the icon and the tag
              text are not separated onto different lines by word wrapping.
            -->
            &nbsp;
            <a class="tag-link" [bawUrl]="tag.viewUrl">{{ tag.text }}</a>
          </div>
        }
      } @else {
        <i>No tags</i>
      }
    </span>

    <span class="info-line">
      <fa-icon class="me-2" [icon]="['fas', 'location-dot']" />

      @let siteModel = annotation().audioRecording.site;
      @if (siteModel | isUnresolved) {
        <baw-loading class="inline-spinner" size="sm" />
      } @else {
        <a [bawUrl]="siteModel.viewUrl">{{ siteModel.name }}</a>
      }
    </span>

    <span class="info-line">
      <fa-icon class="me-2" [icon]="['fas', 'record-vinyl']" />
      <a [bawUrl]="annotation().listenViewUrl">
        <baw-zoned-datetime
          [value]="annotation().audioRecording.recordedDate"
          [timezone]="annotation().audioRecording.recordedDateTimezone"
        />
      </a>
    </span>

    <span class="info-line">
      <fa-icon class="me-2" [icon]="['fas', 'chart-simple']" />
      <span class="tag-score">
        @if (annotation().score | isInstantiated) {
          {{ annotation().score | number }}
        } @else {
          <span
            class="no-score-placeholder tooltip-hint"
            [ngbTooltip]="'This event does not have a score assigned'"
            >No score available</span
          >
        }
      </span>
    </span>

    <span class="info-line">
      <fa-icon class="me-2" [icon]="['fas', 'circle-info']" />
      <a class="more-information-link" [bawUrl]="annotation().viewUrl"
        >More information</a
      >
    </span>
  </div>
</div>

<ng-template #tagVerifications let-verificationSummary="verificationSummary">
  <div class="summary-tooltip">
    @if (verificationSummary.count > 0) {
      <b class="summary-tooltip-decision">
        {{ verificationSummary.consensus.decision }}
      </b>
      ({{ verificationSummary.consensus.ratio | percent }})
    } @else {
      <i>No verifications yet</i>
    }

    <hr />

    <ul class="data-list">
      <li>Correct: {{ verificationSummary.correct | number }}</li>
      <li>Incorrect: {{ verificationSummary.incorrect | number }}</li>
      <li>Unsure: {{ verificationSummary.unsure | number }}</li>
      <li>Skip: {{ verificationSummary.skip | number }}</li>
    </ul>
  </div>
</ng-template>
