<h2>
  Acoustic Event Summary Report

  <a
    id="print-button"
    class="ms-2"
    ngbTooltip="Print this report"
    (click)="printPage()"
  >
    <fa-icon [icon]="['fas', 'print']"></fa-icon>
  </a>
</h2>

<p id="generatedByLabel">
  Generated by {{ currentUser.userName }}
  {{ report.generatedDate ?? DateTime.now() | dateTime }}
</p>

<section id="search-parameters-container">
  <h3>Search Conditions</h3>

  <div class="search-parameter">
    <b>Sites: </b>

    <ng-container
      *ngIf="report.regions as reportRegions; else defaultConditionTemplate"
    >
      <span *ngFor="let item of reportRegions; last as isLast">
        <a [href]="item.viewUrl">{{ item.name }}</a>
        <ng-container *ngIf="!isLast">, </ng-container>
      </span>
    </ng-container>
  </div>

  <div class="search-parameter">
    <b>Points: </b>

    <ng-container *ngIf="report.sites as reportSites; else defaultConditionTemplate">
      <span *ngFor="let item of reportSites; last as isLast">
        <a [href]="item.viewUrl">{{ item.name }}</a>
        <ng-container *ngIf="!isLast">, </ng-container>
      </span>
    </ng-container>
  </div>

  <div class="search-parameter">
    <b>Times: </b>

    <span
      *ngIf="
        parameterDataModel.timeStartedAfter ||
          parameterDataModel.timeFinishedBefore;
        else defaultConditionTemplate
      "
    >
      {{ parameterDataModel.timeStartedAfter | time }} –
      {{ parameterDataModel.timeFinishedBefore | time }}
    </span>
  </div>

  <div class="search-parameter">
    <b>Date Range: </b>

    <span
      *ngIf="
        parameterDataModel.dateStartedAfter ||
          parameterDataModel.dateFinishedBefore;
        else defaultConditionTemplate
      "
    >
      {{ parameterDataModel.dateStartedAfter | dateTime }} –
      {{ parameterDataModel.dateFinishedBefore | dateTime }}
    </span>
  </div>

  <div class="search-parameter">
    <b>Duration: </b> {{ parameterDataModel.bucketSize | titlecase }}
  </div>

  <div class="search-parameter">
    <b>Recognisers: </b>

    <ng-container
      *ngIf="parameterDataModel.provenances; else defaultConditionTemplate"
    >
      <span
        *ngFor="
          let provenance of parameterDataModel.provenances;
          last as isLast
        "
      >
        <a [href]="getProvenance(provenance)?.viewUrl">{{
          getProvenance(provenance)?.name
        }}</a>
        <ng-container *ngIf="!isLast">, </ng-container>
      </span>
    </ng-container>
  </div>

  <div class="search-parameter">
    <b>Score Cutoff: </b>

    <!--
      If the user doesn't explicitly define a provenance score, we should display 0 instead of (not specified)
      This is because this a not specified provenance score allows through all events, which is equivalent to a score cut-off of 0
      To be verbose, we reflect this client side to the user by using 0.0 as the score cut-off instead of (not specified)
    -->
    {{ parameterDataModel.score ?? 0 | number : "1.1-1" }}
  </div>

  <div class="search-parameter">
    <b>Events: </b>

    <ng-container
      *ngIf="
        parameterDataModel.events as reportEvents;
        else defaultConditionTemplate
      "
    >
      <span *ngFor="let item of reportEvents; last as isLast">
        <a [href]="getTag(item).viewUrl">{{ getTag(item)?.text }}</a>
        <ng-container *ngIf="!isLast">, </ng-container>
      </span>
    </ng-container>
  </div>
</section>

<section>
  <h3>Coverage Summary</h3>

  <div class="alert alert-warning p-3 my-3">
    <strong>
      General warning about different recognisers, 'interpret with cation and
      validate' etc; qualifiers about performance in different regions, etc
    </strong>
  </div>

  <baw-site-map
    class="site-map"
    [sites]="filteredSites()"
    [project]="project"
    [region]="region"
  ></baw-site-map>

  <baw-chart
    [spec]="coveragePlotSchema"
    [datasets]="coverageDataset()"
  ></baw-chart>

  <div>
    <div>
      <b>Total requested range: </b>
      {{ unixEpochToDuration(this.report.statistics?.totalSearchSpan) | toRelative }}
    </div>

    <div>
      <b>Total Duration of selected audio recordings: </b>
      {{unixEpochToDuration(this.report.statistics?.audioCoverageOverSpan) | toRelative}}
      (50% of requested range)
    </div>

    <div>
      <b>Total analysed duration of selected audio recordings: </b>
      {{ unixEpochToDuration(this.report.statistics?.analysisCoverageOverSpan) | toRelative }}
      (30% of audio recording range)
    </div>
  </div>
</section>

<section class="events-table-section">
  <h3>
    Events Table

    <a [href]="eventSummaryReportApi.eventDownloadUrl()">
      <fa-icon
        class="download-button"
        [icon]="['fas', 'file-arrow-down']"
        [ngbTooltip]="'Download this table'"
      ></fa-icon>
    </a>
  </h3>

  <table class="table">
    <tr class="row">
      <th class="col">Events</th>
      <th class="col">Recogniser</th>
      <th class="col">Detections</th>
      <th class="col">
        % {{ parameterDataModel.bucketSize | titlecase }}s with Detections
      </th>
      <th class="col">
        % {{ parameterDataModel.bucketSize | titlecase }}s with Rain
      </th>
      <th class="col">Confidence Plot</th>
    </tr>

    <ng-container *ngFor="let item of report.eventGroups">
      <tr class="row">
        <td class="col">
          <a [href]="getTag(item.tagId)?.viewUrl">
            {{ getTag(item.tagId)?.text }}
          </a>
        </td>
        <td class="col">
          <a [href]="getProvenance(item.provenanceId)?.viewUrl">
            {{ getProvenance(item.provenanceId)?.name }}
          </a>
        </td>
        <td class="col">{{ item.detections | number }}</td>
        <td class="col">
          {{ item.bucketsWithDetections | percent }}
        </td>
        <td class="col">{{ item.bucketsWithInterference.length }}</td>
        <td class="col">
          <baw-chart
            class="embedded-figure"
            [spec]="confidencePlotSchema"
            [data]="item.score.histogram"
          ></baw-chart>

          <small class="m-1 text-muted">
            x̄: {{ item.score.mean | number : "1.2-2" }}
          </small>
          <wbr>
          <small class="m-1 text-muted">
            σ: {{ item.score.standardDeviation | number : "1.2-2" }}
          </small>
        </td>
      </tr>
    </ng-container>
  </table>
</section>

<section class="charts-section">
  <h3>Charts</h3>

  <div class="alert alert-info p-3 my-3">
    Some kind of text to put these figures into context.
  </div>

  <div [class.hide-in-print]="!showChart(chartTypes.speciesAccumulationCurve)">
    <h4>
      Species Accumulation Curve

      <a [href]="eventSummaryReportApi.eventDownloadUrl()">
        <fa-icon
          class="download-button"
          [icon]="['fas', 'file-arrow-down']"
          [ngbTooltip]="'Download this graphs data'"
        ></fa-icon>
      </a>

      <button class="toggle-graph-button btn btn-secondary btn-sm">
        <fa-icon
          (click)="
            toggleChart(
              chartTypes.speciesAccumulationCurve,
              !showChart(chartTypes.speciesAccumulationCurve)
            )
          "
          [icon]="[
            'fas',
            showChart(chartTypes.speciesAccumulationCurve)
              ? 'minimize'
              : 'maximize'
          ]"
          [ngbTooltip]="
            showChart(chartTypes.speciesAccumulationCurve)
              ? 'Minimize'
              : 'Maximize'
          "
        ></fa-icon>
      </button>
    </h4>

    <div [ngbCollapse]="!showChart(chartTypes.speciesAccumulationCurve)">
      <baw-chart
        class="large-embedded-figure"
        [spec]="speciesAccumulationCurveSchema"
        [data]="report.graphs?.accumulationData"
      ></baw-chart>
    </div>
  </div>

  <div [class.hide-in-print]="!showChart(chartTypes.speciesCompositionCurve)">
    <h4>
      Species Composition

      <a [href]="eventSummaryReportApi.eventDownloadUrl()">
        <fa-icon
          class="download-button"
          [icon]="['fas', 'file-arrow-down']"
          [ngbTooltip]="'Download this graphs data'"
        ></fa-icon>
      </a>

      <button class="toggle-graph-button btn btn-secondary btn-sm">
        <fa-icon
          (click)="
            toggleChart(
              chartTypes.speciesCompositionCurve,
              !showChart(chartTypes.speciesCompositionCurve)
            )
          "
          [icon]="[
            'fas',
            showChart(chartTypes.speciesCompositionCurve)
              ? 'minimize'
              : 'maximize'
          ]"
          [ngbTooltip]="
            showChart(chartTypes.speciesCompositionCurve)
              ? 'Minimize'
              : 'Maximize'
          "
        ></fa-icon>
      </button>
    </h4>

    <div [ngbCollapse]="!showChart(chartTypes.speciesCompositionCurve)">
      <baw-chart
        class="large-embedded-figure"
        [spec]="speciesCompositionCurveSchema"
        [data]="report.graphs?.speciesCompositionData"
        [formatter]="vegaTagTextFormatter"
      ></baw-chart>
    </div>
  </div>

  <div
    *ngIf="spectrogramUrls.length > 0"
    [class.hide-in-print]="!showChart(chartTypes.falseColorSpectrograms)"
  >
    <h4>
      False colour spectrogram(s)

      <a [href]="eventSummaryReportApi.eventDownloadUrl()">
        <fa-icon
          class="download-button"
          [icon]="['fas', 'file-arrow-down']"
          [ngbTooltip]="'Download false colour spectrogram(s)'"
        ></fa-icon>
      </a>

      <button class="toggle-graph-button btn btn-secondary btn-sm">
        <fa-icon
          class="toggle-graph-button btn btn-secondary btn-sm"
          (click)="
            toggleChart(
              chartTypes.falseColorSpectrograms,
              !showChart(chartTypes.falseColorSpectrograms)
            )
          "
          [icon]="[
            'fas',
            showChart(chartTypes.falseColorSpectrograms)
              ? 'minimize'
              : 'maximize'
          ]"
          [ngbTooltip]="
            showChart(chartTypes.falseColorSpectrograms)
              ? 'Minimize'
              : 'Maximize'
          "
        ></fa-icon>
      </button>
    </h4>
    <div [ngbCollapse]="!showChart(chartTypes.falseColorSpectrograms)">
      <div class="large-embedded-figure p-1">False colour spectrogram(s)</div>
    </div>
  </div>
</section>

<ng-template #defaultConditionTemplate> (not specified) </ng-template>
