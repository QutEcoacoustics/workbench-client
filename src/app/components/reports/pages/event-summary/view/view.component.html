<h2>
  Acoustic Event Summary Report

  <a
    id="print-button"
    class="ms-2"
    ngbTooltip="Print this report"
    (click)="openPrintModal()"
  >
    <fa-icon [icon]="['fas', 'print']"></fa-icon>
  </a>
</h2>

<p id="generatedByLabel">
  Generated by {{ currentUser.userName }}
  {{ report.generatedDate ?? DateTime.now() | dateTime }}
</p>

<section id="search-parameters-container">
  <h3>Search Conditions</h3>

  <div class="search-parameter">
    <b>Sites: </b>

    <ng-container
      *ngIf="report.regions as reportRegions; else defaultConditionTemplate"
    >
      <span *ngFor="let item of reportRegions; last as isLast">
        <a *ngIf="item" [href]="item.viewUrl">{{ item.name }}</a>
        <ng-container *ngIf="!isLast">, </ng-container>
      </span>
    </ng-container>
  </div>

  <div class="search-parameter">
    <b>Points: </b>

    <ng-container
      *ngIf="report.sites as reportSites; else defaultConditionTemplate"
    >
      <span *ngFor="let item of reportSites; last as isLast">
        <a *ngIf="item" [href]="item.viewUrl">{{ item.name }}</a>
        <ng-container *ngIf="!isLast">, </ng-container>
      </span>
    </ng-container>
  </div>

  <div class="search-parameter">
    <b>Times: </b>

    <span
      *ngIf="
        parameterDataModel.timeStartedAfter ||
          parameterDataModel.timeFinishedBefore;
        else defaultConditionTemplate
      "
    >
      {{ parameterDataModel.timeStartedAfter | time }} –
      {{ parameterDataModel.timeFinishedBefore | time }}
    </span>
  </div>

  <div class="search-parameter">
    <b>Daylight Savings: </b>

    <span
      *ngIf="
        parameterDataModel.timeStartedAfter ||
          parameterDataModel.timeFinishedBefore;
        else defaultConditionTemplate
      "
    >
      {{ parameterDataModel.daylightSavings ? "Yes" : "No" }}
    </span>
  </div>

  <div class="search-parameter">
    <b>Date Range: </b>

    <span
      *ngIf="
        parameterDataModel.dateStartedAfter ||
          parameterDataModel.dateFinishedBefore;
        else defaultConditionTemplate
      "
    >
      {{ parameterDataModel.dateStartedAfter | dateTime }} –
      {{ parameterDataModel.dateFinishedBefore | dateTime }}
    </span>
  </div>

  <div class="search-parameter">
    <b>Duration: </b>
    <span class="bucket-size-label" [ngbTooltip]="'This is determined by your selected bucket size'">
      {{ parameterDataModel.bucketSize | titlecase }}
    </span>
  </div>

  <div class="search-parameter">
    <b>Recognisers: </b>

    <ng-container
      *ngIf="
        !!parameterDataModel.provenanceModels;
        else defaultConditionTemplate
      "
    >
      <span
        *ngFor="
          let provenance of parameterDataModel.provenanceModels;
          last as isLast
        "
      >
        <a *ngIf="provenance" [href]="provenance.viewUrl">
          {{ provenance }}
        </a>
        <ng-container *ngIf="!isLast">, </ng-container>
      </span>
    </ng-container>
  </div>

  <div class="search-parameter">
    <b>Score Threshold: </b>

    <!--
      If the user doesn't explicitly define a provenance score, we should display 0 instead of (not specified)
      This is because this a not specified provenance score allows through all tags, which is equivalent to a score cut-off of 0
      To be verbose, we reflect this client side to the user by using 0.0 as the score cut-off instead of (not specified)
    -->
    {{ parameterDataModel.score ?? 0 | number : "1.2-2" }}
  </div>

  <div class="search-parameter">
    <b>Tags: </b>

    <ng-container
      *ngIf="
        parameterDataModel.tagModels as reportTags;
        else defaultConditionTemplate
      "
    >
      <span *ngFor="let event of reportTags; last as isLast">
        <a *ngIf="event" [href]="event.viewUrl">
          {{ event }}
        </a>
        <ng-container *ngIf="!isLast">, </ng-container>
      </span>
    </ng-container>
  </div>
</section>

<section>
  <h3>Coverage Summary</h3>

  <div class="alert alert-warning my-3">
    General warning about different recognisers, 'interpret with cation and
    validate' etc; qualifiers about performance in different regions, etc
  </div>

  <h4>Geographic Coverage</h4>

  <baw-site-map
    class="site-map"
    [sitesSubset]="filteredSites()"
    [project]="project"
    [region]="region"
  ></baw-site-map>

  <h4>Coverage</h4>

  <baw-chart
    [spec]="coveragePlotSchema"
    [datasets]="report.graphs.coverageData"
  ></baw-chart>

  <div>
    <table class="table">
      <tr class="row">
        <th class="col">Condition</th>
        <th class="col">Duration</th>
        <th class="col">Percent Coverage</th>
      </tr>

      <tr class="row">
        <td class="col">Search Range</td>
        <td class="col">
          {{
            unixEpochToDuration(this.report.statistics?.totalSearchSpan)
              | toRelative
          }}
        </td>
        <td class="col">
          <span [ngbTooltip]="'The number of search range covered'">
            100%
          </span>
        </td>
      </tr>

      <tr class="row">
        <td class="col">Audio</td>
        <td class="col">
          {{
            unixEpochToDuration(this.report.statistics?.audioCoverageOverSpan)
              | toRelative
          }}
        </td>
        <td class="col">
          <span [ngbTooltip]="'The number of search range covered by recordings'">
            80%
          </span>
        </td>
      </tr>

      <tr class="row">
        <td class="col">Analysis</td>
        <td class="col">
          {{
            unixEpochToDuration(this.report.statistics?.analysisCoverageOverSpan)
              | toRelative
          }}
        </td>
        <td class="col">
          <span [ngbTooltip]="'The number of search range covered by analysis'">
            60%
          </span>
        </td>
      </tr>
    </table>
  </div>
</section>

<section id="events-table-container">
  <h3>
    Summary of Events

    <a
      class="download-button"
      [href]="
        eventSummaryReportApi.downloadEventsTableUrl(
          parameterDataModel.toFilter()
        )
      "
    >
      <fa-icon
        [icon]="['fas', 'file-arrow-down']"
        [ngbTooltip]="'Download this table'"
      ></fa-icon>
    </a>
  </h3>

  <table class="table">
    <tr class="row">
      <th class="col">Tags</th>
      <th class="col">Recogniser</th>
      <th class="col">Detections</th>
      <th class="col">
        %<span class="bucket-size-label" [ngbTooltip]="'This is determined by your selected bucket size'">{{ parameterDataModel.bucketSize | titlecase }}s</span>with Detections
      </th>
      <th class="col">Score Plot</th>
    </tr>

    <ng-container *ngFor="let item of report.eventGroups">
      <tr class="row">
        <td class="col">
          <a *ngIf="isResolvedModel(item.tag)" [href]="item.tag.viewUrl">
            {{ item.tag.text }}
          </a>
        </td>
        <td class="col">
          <a
            *ngIf="item.provenance"
            [href]="item.provenance.viewUrl"
          >
            {{ item.provenance }}
          </a>
        </td>
        <td class="col">{{ item.detections | number }}</td>
        <td class="col">
          {{ item.bucketsWithDetections | percent }}
        </td>
        <td class="col">
          <baw-chart
            class="embedded-figure"
            [spec]="confidencePlotSchema"
            [data]="item.score.histogram"
          ></baw-chart>

          <small class="m-1 text-muted text-nowrap">
            x̄: {{ item.score.mean | number : "1.2-2" }}
          </small>
          <wbr />
          <small class="m-1 text-muted text-nowrap">
            σ: {{ item.score.standardDeviation | number : "1.2-2" }}
          </small>
        </td>
      </tr>
    </ng-container>
  </table>
</section>

<section id="charts-container">
  <h3>Charts</h3>

  <div class="alert alert-info my-3">
    Some kind of text to put these figures into context.
  </div>

  <div
    class="chart-container"
    [class.hide-in-print]="
      !shouldShowChart(chartTypes.speciesAccumulationCurve)
    "
  >
    <div class="chart-heading">
      <h4 class="chart-title">Species Accumulation Curve</h4>

      <a
        class="download-button"
        (click)="accumulationChart.downloadChartAsCsv()"
      >
        <fa-icon
          [icon]="['fas', 'file-arrow-down']"
          [ngbTooltip]="'Download this graphs data'"
        ></fa-icon>
      </a>

      <button
        class="toggle-graph-button btn btn-secondary btn-sm"
        (click)="
          toggleChart(
            chartTypes.speciesAccumulationCurve,
            !shouldShowChart(chartTypes.speciesAccumulationCurve)
          )
        "
      >
        <fa-icon
          [icon]="[
            'fas',
            shouldShowChart(chartTypes.speciesAccumulationCurve)
              ? 'minimize'
              : 'maximize'
          ]"
          [ngbTooltip]="
            shouldShowChart(chartTypes.speciesAccumulationCurve)
              ? 'Minimize'
              : 'Maximize'
          "
        ></fa-icon>
      </button>
    </div>

    <ng-container></ng-container>
    <div [ngbCollapse]="!shouldShowChart(chartTypes.speciesAccumulationCurve)">
      <baw-chart
        #accumulationChart
        class="large-embedded-figure"
        [spec]="speciesAccumulationCurveSchema"
        [data]="report.graphs?.accumulationData"
      ></baw-chart>
    </div>
  </div>

  <div
    class="chart-container"
    [class.hide-in-print]="!shouldShowChart(chartTypes.speciesCompositionCurve)"
  >
    <div class="chart-heading">
      <h4 class="chart-title">Species Composition</h4>

      <a
        class="download-button"
        (click)="compositionChart.downloadChartAsCsv()"
      >
        <fa-icon
          [icon]="['fas', 'file-arrow-down']"
          [ngbTooltip]="'Download this graphs data'"
        ></fa-icon>
      </a>

      <button
        class="toggle-graph-button btn btn-secondary btn-sm"
        (click)="
          toggleChart(
            chartTypes.speciesCompositionCurve,
            !shouldShowChart(chartTypes.speciesCompositionCurve)
          )
        "
      >
        <fa-icon
          [icon]="[
            'fas',
            shouldShowChart(chartTypes.speciesCompositionCurve)
              ? 'minimize'
              : 'maximize'
          ]"
          [ngbTooltip]="
            shouldShowChart(chartTypes.speciesCompositionCurve)
              ? 'Minimize'
              : 'Maximize'
          "
        ></fa-icon>
      </button>
    </div>

    <ng-container *ngIf="parameterDataModel.tagModels.length">
      <div [ngbCollapse]="!shouldShowChart(chartTypes.speciesCompositionCurve)">
        <baw-chart
          #compositionChart
          class="large-embedded-figure"
          [spec]="speciesCompositionCurveSchema"
          [data]="report.graphs?.speciesCompositionData"
          [formatter]="vegaTagTextFormatter"
        ></baw-chart>
      </div>
    </ng-container>
  </div>

  <!-- TODO: Enable this chart once false colour spectrograms are functional -->
  <div
    *ngIf="false"
    class="chart-container"
    [class.hide-in-print]="!shouldShowChart(chartTypes.falseColorSpectrograms)"
  >
    <div class="chart-heading">
      <h4 class="chart-title">False colour spectrogram(s)</h4>

      <a
        class="download-button"
        (click)="compositionChart.downloadChartAsCsv()"
      >
        <fa-icon
          [icon]="['fas', 'file-arrow-down']"
          [ngbTooltip]="'Download false colour spectrogram(s)'"
        ></fa-icon>
      </a>

      <button
        class="toggle-graph-button btn btn-secondary btn-sm"
        (click)="
          toggleChart(
            chartTypes.falseColorSpectrograms,
            !shouldShowChart(chartTypes.falseColorSpectrograms)
          )
        "
      >
        <fa-icon
          [icon]="[
            'fas',
            shouldShowChart(chartTypes.falseColorSpectrograms)
              ? 'minimize'
              : 'maximize'
          ]"
          [ngbTooltip]="
            shouldShowChart(chartTypes.falseColorSpectrograms)
              ? 'Minimize'
              : 'Maximize'
          "
        ></fa-icon>
      </button>
    </div>

    <div [ngbCollapse]="!shouldShowChart(chartTypes.falseColorSpectrograms)">
      <div class="large-embedded-figure p-1">False colour spectrogram(s)</div>
    </div>
  </div>
</section>

<ng-template #defaultConditionTemplate> (not specified) </ng-template>

<!-- The printing modal that is used to show useful information about best printing practices -->
<ng-template #printingModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-basic-title">Printing Confirmation</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss()"
    ></button>
  </div>

  <div class="modal-body">
    <div class="hide-in-print">
      <p>
        When saving to PDF, use the "Save to PDF" as the destination to have
        clickable links.
      </p>
      <p>Supported browsers: Chrome, Firefox, Edge</p>
      <p>Supported page sizes: A2, A3, A4, A5, Letter</p>
    </div>

    <div class="form-check">
      <label for="dont-show-again" class="form-check-label"
        >Don't show again</label
      >
      <input
        #doNotShowAgainCheckbox
        id="dont-show-again"
        class="form-check-input"
        type="checkbox"
        (change)="changePrintModalPreference(doNotShowAgainCheckbox.checked)"
      />
    </div>
  </div>

  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-outline-danger"
      (click)="modal.dismiss()"
    >
      Close
    </button>
    <button
      type="button"
      class="btn btn-primary float-end"
      (click)="modal.close(); printPage()"
    >
      Print
    </button>
  </div>
</ng-template>
