<h2>
  Acoustic Event Summary Report

  <a id="print-button" class="ms-3" (click)="printPage()">
    <fa-icon [icon]="['fas', 'print']"></fa-icon>
  </a>
</h2>

<div class="generatedByLabel fst-italic">
  Generated by {{ currentUser.userName }}
  {{ report.generatedDate ?? DateTime.now() | dateTime }}
</div>

<section>
  <h3>Search Parameters</h3>

  <div class="reportInformation container">
    <div class="row py-2">
      <div class="col fw-bold">Sites</div>

      <div *ngIf="regions | async as reportRegions" class="col">
        <span *ngFor="let item of reportRegions; let last = last">
          {{ item.name }}
          <ng-container *ngIf="!last">,</ng-container>
        </span>
      </div>

      <div *ngIf="!parameterDataModel.sites" class="col">(not specified)</div>

      <div class="col fw-bold">Points</div>

      <div *ngIf="sites | async as reportSites" class="col">
        <span *ngFor="let item of reportSites; let last = last">
          {{ item.name }}
          <ng-container *ngIf="!last">,</ng-container>
        </span>
      </div>

      <div *ngIf="!parameterDataModel.points" class="col">(not specified)</div>
    </div>

    <div class="row py-2">
      <div class="col fw-bold">Times</div>

      <div
        *ngIf="
          parameterDataModel.timeStartedAfter ||
          parameterDataModel.timeFinishedBefore
        "
        class="col"
      >
        {{ parameterDataModel.timeStartedAfter | time }} –
        {{ parameterDataModel.timeFinishedBefore | time }}
      </div>

      <div
        *ngIf="
          !parameterDataModel.timeStartedAfter &&
          !parameterDataModel.timeFinishedBefore
        "
        class="col"
      >
        (not specified)
      </div>

      <div class="col fw-bold">Date Range</div>

      <div
        *ngIf="
          parameterDataModel.dateStartedAfter ||
          parameterDataModel.dateFinishedBefore
        "
        class="col"
      >
        {{ parameterDataModel.dateStartedAfter | dateTime }} –
        {{ parameterDataModel.dateFinishedBefore | dateTime }}
      </div>

      <div
        *ngIf="
          !parameterDataModel.dateStartedAfter &&
          !parameterDataModel.dateFinishedBefore
        "
        class="col"
      >
        (not specified)
      </div>
    </div>

    <div class="row py-2">
      <div class="col fw-bold">Duration</div>

      <div class="col">{{ parameterDataModel.bucketSize | titlecase }}</div>

      <div class="col fw-bold">Recognisers</div>

      <div *ngIf="parameterDataModel.provenances" class="col">
        <ng-container *ngIf="provenanceNames() | async as provenanceNames">
          <span *ngFor="let item of provenanceNames; let last = last">
            {{ item }}
            <ng-container *ngIf="!last">,</ng-container>
          </span>
        </ng-container>
      </div>

      <div *ngIf="!parameterDataModel.provenances" class="col">
        (not specified)
      </div>
    </div>

    <div class="row py-2">
      <div class="col fw-bold">Score Cutoff</div>

      <div class="col">
        {{
          parameterDataModel.score ??
            ViewEventReportComponent.defaultFilterText()
          | number: '1.1-1'
        }}
      </div>

      <div class="col fw-bold">Events</div>

      <div *ngIf="tags | async as reportEvents" class="col">
        <span *ngFor="let item of reportEvents; let last = last">
          {{ item.text }}
          <ng-container *ngIf="!last">,</ng-container>
        </span>
      </div>

      <div *ngIf="!parameterDataModel.events" class="col">
      </div>
    </div>
  </div>
</section>

<section>
  <h3>Summary</h3>

  <div class="reportOverview">
    <div class="alert alert-warning p-3 my-3">
      <strong>
        General warning about different recognisers, 'interpret with cation and
        validate' etc; qualifiers about performance in different regions, etc
      </strong>
    </div>

    <div class="container">
      <div class="row">
        <div class="col">
          <div class="speciesList">
            <!-- TODO: Fetching these values. This will most likely require a 3rd party API -->
            <h4 class="py-1">Native Species: 5</h4>
            <h4 class="py-1">Non-native: 3</h4>
            <h4 class="py-1">Invasive: 3</h4>
          </div>
        </div>

        <div class="col">
          <div name="siteMap">
            <baw-site-map
              class="site-map"
              [project]="project"
              [region]="region"
              [sites]="sites | async"
            ></baw-site-map>
          </div>
        </div>
      </div>
    </div>

    <div class="border border-5 p-2 m-2">
      Time series graph
    </div>

    <div class="border border-5 p-2 m-2">
      Time series graph
    </div>
  </div>
</section>

<section>
  <h3>Events Table</h3>

  <div class="events-table">
    <div class="py-4">
      <b>Total number of {{ parameterDataModel.bucketSize | titlecase }}s analysed: </b>
      {{ report.statistics?.countOfRecordingsAnalyzed }}
      {{ parameterDataModel.bucketSize | titlecase }}s <br />
      <strong>
        {{ audioCoverageOverSpan() | toRelative }}
      </strong>
      of recordings were found within the requested
      <strong>
        {{ totalSearchSpan() | toRelative }}
      </strong>
      <a
        name="downloadEventsLink"
        class="link-primary"
        href="{{ eventDownloadUrl }}"
        >download this table</a
      >.
    </div>

    <table class="table">
      <tr class="row">
        <th class="col border py-1 fw-bold">Events</th>
        <th class="col border py-1 fw-bold">Recogniser</th>
        <th class="col border py-1 fw-bold"># Detections</th>
        <th class="col border py-1 fw-bold">
          Detection {{ parameterDataModel.bucketSize | titlecase }}s
        </th>
        <th class="col border py-1 fw-bold">
          {{ parameterDataModel.bucketSize | titlecase }}s with Rain
        </th>
        <th class="col border py-1 fw-bold border">Confidence Plot</th>
      </tr>

      <ng-container *ngFor="let item of report.eventGroups">
        <tr class="row">
          <td class="col border py-1">{{ item.tagId }}</td>
          <td class="col border py-1">{{ item.provenanceId }}</td>
          <td class="col border py-1">{{ item.detections | number }}</td>
          <td class="col border py-1">{{ item.bucketsWithDetections | number }}</td>
          <td class="col border py-1">{{ bucketsWithRain(item) | number }}</td>
          <td class="col border py-1">
            <baw-chart
              class="embedded-figure"
              [spec]="confidencePlotSchema"
              [data]="item.score.histogram"
              [options]="{ actions: false }"
            ></baw-chart>

            <small class="m-1 text-muted">x̄: {{ item.score.mean | number: '1.2-2' }}</small>
            <small class="m-1 text-muted"
              >σ: {{ item.score.standardDeviation | number: '1.2-2' }}</small
            >
          </td>
        </tr>
      </ng-container>
    </table>
  </div>
</section>

<section>
  <h3>Graphs</h3>

  <div class="alert alert-info p-3 my-3">
    Some kind of text to put these figures into context.
  </div>

  <div class="my-1">
    <button
      class="btn btn-secondary"
      (click)="siteMapCollapsed = !siteMapCollapsed"
      aria-controls="collapseExample"
      aria-expanded="false"
    >
      Toggle Sitemap
    </button>
    <div id="siteMapContainer" [ngbCollapse]="siteMapCollapsed">
      <h4>Site Map</h4>
      <div class="large-embedded-figure p-1">
        <baw-site-map
          class="w-100 h-100"
          [project]="project"
          [region]="region"
          [sites]="sites | async"
        ></baw-site-map>
      </div>
    </div>
  </div>

  <div class="my-1" *ngIf="report.graphs?.accumulationData">
    <button
      class="btn btn-secondary"
      (click)="accumulationCurveCollapsed = !accumulationCurveCollapsed"
      aria-controls="collapseExample"
      aria-expanded="false"
    >
      Toggle Accumulation Curve
    </button>
    <div [ngbCollapse]="accumulationCurveCollapsed">
      <h4>Species Accumulation Curve</h4>
      <baw-chart
        class="large-embedded-figure"
        [spec]="speciesAccumulationCurveSchema"
        [data]="report.graphs?.accumulationData"
      ></baw-chart>
    </div>
  </div>

  <div class="my-1" *ngIf="report.graphs?.speciesCompositionData">
    <button
      class="btn btn-secondary"
      (click)="compositionCurveCollapsed = !compositionCurveCollapsed"
      aria-controls="collapseExample"
      aria-expanded="false"
    >
      Toggle Composition Curve
    </button>
    <div [ngbCollapse]="compositionCurveCollapsed">
      <h4>Species Composition</h4>
      <baw-chart
        class="large-embedded-figure"
        [spec]="speciesCompositionCurveSchema"
        [data]="report.graphs?.speciesCompositionData"
      ></baw-chart>
    </div>
  </div>

  <div class="my-1">
    <button
      class="btn btn-secondary"
      (click)="
        falseColorSpectrogramsCollapsed = !falseColorSpectrogramsCollapsed
      "
      aria-controls="collapseExample"
      aria-expanded="false"
    >
      Toggle False Colour Spectrograms
    </button>
    <div [ngbCollapse]="falseColorSpectrogramsCollapsed">
      <h4>False colour spectrogram(s)</h4>
      <div class="large-embedded-figure p-1">False colour spectrogram(s)</div>
    </div>
  </div>
</section>
