<h2>
  Acoustic Event Summary Report

  <a id="print-button" class="ms-2" (click)="printPage()">
    <fa-icon [icon]="['fas', 'print']"></fa-icon>
  </a>
</h2>

<p id="generatedByLabel">
  Generated by {{ currentUser.userName }}
  {{ report.generatedDate ?? DateTime.now() | dateTime }}
</p>

<section class="search-parameters-container">
  <h3>Search Conditions</h3>

  <div class="search-parameter">
    <b>Sites:</b>

    <ng-container
      *ngIf="regions | async as reportRegions; else defaultConditionTemplate"
    >
      <ng-container *ngFor="let item of reportRegions; let last = last">
        <a [href]="item.viewUrl">
          {{ item.name }}
        </a>
        <ng-container *ngIf="!last">,</ng-container>
      </ng-container>
    </ng-container>
  </div>

  <div class="search-parameter">
    <b>Points:</b>

    <ng-container
      *ngIf="sites | async as reportSites; else defaultConditionTemplate"
    >
      <ng-container *ngFor="let item of reportSites; let last = last">
        <a [href]="item.viewUrl">
          {{ item.name }}
        </a>
        <ng-container *ngIf="!last">,</ng-container>
      </ng-container>
    </ng-container>
  </div>

  <div class="search-parameter">
    <b>Times:</b>

    <span
      *ngIf="
        parameterDataModel.timeStartedAfter ||
          parameterDataModel.timeFinishedBefore;
        else defaultConditionTemplate
      "
    >
      {{ parameterDataModel.timeStartedAfter | time }} –
      {{ parameterDataModel.timeFinishedBefore | time }}
    </span>
  </div>

  <div class="search-parameter">
    <b>Date Range:</b>

    <span
      *ngIf="
        parameterDataModel.dateStartedAfter ||
          parameterDataModel.dateFinishedBefore;
        else defaultConditionTemplate
      "
    >
      {{ parameterDataModel.dateStartedAfter | dateTime }} –
      {{ parameterDataModel.dateFinishedBefore | dateTime }}
    </span>
  </div>

  <div class="search-parameter">
    <b>Duration:</b> {{ parameterDataModel.bucketSize | titlecase }}
  </div>

  <div class="search-parameter">
    <b>Recognisers:</b>

    <ng-container
      *ngIf="parameterDataModel.provenances; else defaultConditionTemplate"
    >
      <ng-container
        *ngFor="
          let provenance of parameterDataModel.provenances;
          let last = last
        "
      >
        <a [href]="(getProvenance(provenance) | async).viewUrl">
          {{ (getProvenance(provenance) | async).name }}
        </a>
        <ng-container *ngIf="!last">,</ng-container>
      </ng-container>
    </ng-container>
  </div>

  <div class="search-parameter">
    <b>Score Cutoff:</b>

    {{
      parameterDataModel.score ?? ViewEventReportComponent.defaultFilterText()
        | number : "1.1-1"
    }}
  </div>

  <div class="search-parameter">
    <b>Events:</b>

    <ng-container
      *ngIf="tags | async as reportEvents; else defaultConditionTemplate"
    >
      <ng-container *ngFor="let item of reportEvents; let last = last">
        <a [href]="item.viewUrl">
          {{ item.text }}
        </a>
        <ng-container *ngIf="!last">,</ng-container>
      </ng-container>
    </ng-container>
  </div>
</section>

<section>
  <h3>Summary</h3>

  <div>
    <div class="alert alert-warning p-3 my-3">
      <strong>
        General warning about different recognisers, 'interpret with cation and
        validate' etc; qualifiers about performance in different regions, etc
      </strong>
    </div>

    <span class="d-flex">
      <div class="w-25">
        <!-- TODO: Fetching these values. This will most likely require a 3rd party API -->
        <h4>Native Species: 5</h4>
        <h4>Non-native: 3</h4>
        <h4>Invasive: 3</h4>
      </div>

      <baw-site-map
        class="site-map"
        [sites]="selectedSites() | async"
      ></baw-site-map>
    </span>

    <baw-chart [spec]="coveragePlotSchema" [data]="coverageData()"></baw-chart>

    <p>
      For the requested {{ totalSearchSpan() | toRelative }}, we've analysed 90%
    </p>
  </div>
</section>

<section class="events-table">
  <h3>Events Table</h3>

  <div class="py-4">
    <b
      >Total number of {{ parameterDataModel.bucketSize | titlecase }}s
      analysed:</b
    >
    {{ report.statistics?.countOfRecordingsAnalyzed }}
    {{ parameterDataModel.bucketSize | titlecase }}s <br />
    <b>
      {{ audioCoverageOverSpan() | toRelative }}
    </b>
    of recordings were found within the requested
    <b>
      {{ totalSearchSpan() | toRelative }}
    </b>

    <a [href]="eventDownloadUrl">
      <fa-icon
        [icon]="['fas', 'file-arrow-down']"
        [ngbTooltip]="'Download this table'"
      ></fa-icon>
    </a>
  </div>

  <table class="table">
    <tr class="row">
      <th class="col">Events</th>
      <th class="col">Recogniser</th>
      <th class="col">Detections</th>
      <th class="col">
        % {{ parameterDataModel.bucketSize | titlecase }}s with Detections
      </th>
      <th class="col">
        % {{ parameterDataModel.bucketSize | titlecase }}s with Rain
      </th>
      <th class="col">Confidence Plot</th>
    </tr>

    <ng-container *ngFor="let item of report.eventGroups">
      <tr class="row">
        <td class="col">
          <a [href]="(getTag(item.tagId) | async).viewUrl">
            {{ (getTag(item.tagId) | async).text }}
          </a>
        </td>
        <td class="col">
          <a [href]="(getProvenance(item.provenanceId) | async).viewUrl">
            {{ (getProvenance(item.provenanceId) | async).name }}
          </a>
        </td>
        <td class="col">{{ item.detections | number }}</td>
        <td class="col">
          {{ item.bucketsWithDetections | percent }}
        </td>
        <td class="col">{{ bucketsWithRain(item) | percent }}</td>
        <td class="col">
          <baw-chart
            class="embedded-figure"
            [spec]="confidencePlotSchema"
            [data]="item.score.histogram"
          ></baw-chart>

          <small class="m-1 text-muted">
            x̄: {{ item.score.mean | number : "1.2-2" }}
          </small>
          <small class="m-1 text-muted">
            σ: {{ item.score.standardDeviation | number : "1.2-2" }}
          </small>
        </td>
      </tr>
    </ng-container>
  </table>
</section>

<section>
  <h3>Charts</h3>

  <div class="alert alert-info p-3 my-3">
    Some kind of text to put these figures into context.
  </div>

  <div
    *ngIf="report.graphs?.accumulationData"
    [class.hide-in-print]="accumulationCurveCollapsed"
  >
    <h4>
      Species Accumulation Curve

      <a [href]="eventDownloadUrl">
        <fa-icon
          class="hide-in-print"
          [icon]="['fas', 'file-arrow-down']"
          [ngbTooltip]="'Download this graphs data'"
        ></fa-icon>
      </a>

      <fa-icon
        class="toggle-graph-button btn btn-secondary btn-sm"
        (click)="accumulationCurveCollapsed = !accumulationCurveCollapsed"
        [icon]="['fas', accumulationCurveCollapsed ? 'maximize' : 'minimize']"
      ></fa-icon>
    </h4>

    <div [ngbCollapse]="accumulationCurveCollapsed">
      <baw-chart
        class="large-embedded-figure"
        [spec]="speciesAccumulationCurveSchema"
        [data]="report.graphs?.accumulationData"
      ></baw-chart>
    </div>
  </div>

  <div
    *ngIf="report.graphs?.speciesCompositionData"
    [class.hide-in-print]="compositionCurveCollapsed"
  >
    <h4>
      Species Composition

      <a [href]="eventDownloadUrl">
        <fa-icon
          class="hide-in-print"
          [icon]="['fas', 'file-arrow-down']"
          [ngbTooltip]="'Download this graphs data'"
        ></fa-icon>
      </a>

      <fa-icon
        class="toggle-graph-button btn btn-secondary btn-sm"
        (click)="compositionCurveCollapsed = !compositionCurveCollapsed"
        [icon]="['fas', compositionCurveCollapsed ? 'maximize' : 'minimize']"
      ></fa-icon>
    </h4>

    <div [ngbCollapse]="compositionCurveCollapsed">
      <baw-chart
        class="large-embedded-figure"
        [spec]="speciesCompositionCurveSchema"
        [data]="report.graphs?.speciesCompositionData"
      ></baw-chart>
    </div>
  </div>

  <div
    *ngIf="spectrogramUrls.length"
    [class.hide-in-print]="spectrogramsCollapsed"
  >
    <h4>
      False colour spectrogram(s)

      <a [href]="eventDownloadUrl">
        <fa-icon
          class="hide-in-print"
          [icon]="['fas', 'file-arrow-down']"
          [ngbTooltip]="'Download false colour spectrogram(s)'"
        ></fa-icon>
      </a>

      <fa-icon
        class="toggle-graph-button btn btn-secondary btn-sm"
        (click)="spectrogramsCollapsed = !spectrogramsCollapsed"
        [icon]="['fas', spectrogramsCollapsed ? 'maximize' : 'minimize']"
      ></fa-icon>
    </h4>
    <div [ngbCollapse]="spectrogramsCollapsed">
      <div class="large-embedded-figure p-1">False colour spectrogram(s)</div>
    </div>
  </div>
</section>

<ng-template #defaultConditionTemplate> (not specified) </ng-template>
