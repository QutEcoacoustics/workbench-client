<h2>
  Acoustic Event Summary Report

  <a id="print-button" class="ms-3" (click)="printPage()">
    <fa-icon [icon]="['fas', 'print']"></fa-icon>
  </a>
</h2>

<div class="generatedByLabel">
  <i>
    Generated by {{ currentUser.userName }}
    {{ report.generatedDate ?? DateTime.now() | dateTime }}
  </i>
</div>

<section>
  <h3>Search Conditions</h3>

  <div class="search-parameters">
    <div class="search-parameters-container">
      <b>Sites:</b>

      <span *ngIf="regions | async as reportRegions">
        <ng-container *ngFor="let item of reportRegions; let last = last">
          <a [href]="item.viewUrl">
            {{ item.name }}
          </a>
          <ng-container *ngIf="!last">,</ng-container>
        </ng-container>
      </span>

      <span *ngIf="!parameterDataModel.sites">(not specified)</span>
    </div>

    <div class="search-parameters-container">
      <b>Points:</b>

      <span *ngIf="sites | async as reportSites">
        <ng-container *ngFor="let item of reportSites; let last = last">
          <a [href]="item.viewUrl">
            {{ item.name }}
          </a>
          <ng-container *ngIf="!last">,</ng-container>
        </ng-container>
      </span>

      <span *ngIf="!parameterDataModel.points">(not specified)</span>
    </div>

    <div class="search-parameters-container">
      <b>Times:</b>

      <span
        *ngIf="
          parameterDataModel.timeStartedAfter ||
          parameterDataModel.timeFinishedBefore
        "
      >
        {{ parameterDataModel.timeStartedAfter | time }} –
        {{ parameterDataModel.timeFinishedBefore | time }}
      </span>

      <span
        *ngIf="
          !parameterDataModel.timeStartedAfter &&
          !parameterDataModel.timeFinishedBefore
        "
      >
        (not specified)
      </span>
    </div>

    <div class="search-parameters-container">
      <b>Date Range:</b>

      <span
        *ngIf="
          parameterDataModel.dateStartedAfter ||
          parameterDataModel.dateFinishedBefore
        "
      >
        {{ parameterDataModel.dateStartedAfter | dateTime }} –
        {{ parameterDataModel.dateFinishedBefore | dateTime }}
      </span>

      <span
        *ngIf="
          !parameterDataModel.dateStartedAfter &&
          !parameterDataModel.dateFinishedBefore
        "
      >
        (not specified)
      </span>
    </div>

    <div class="search-parameters-container">
      <b>Duration:</b> {{ parameterDataModel.bucketSize | titlecase }}
    </div>

    <div class="search-parameters-container">
      <b>Recognisers:</b>

      <span *ngIf="parameterDataModel.provenances">
        <ng-container
          *ngFor="
            let provenance of parameterDataModel.provenances;
            let last = last
          "
        >
          <a [href]="(getProvenance(provenance) | async).viewUrl">
            {{ (getProvenance(provenance) | async).name }}
          </a>
          <ng-container *ngIf="!last">,</ng-container>
        </ng-container>
      </span>

      <span *ngIf="!parameterDataModel.provenances"> (not specified) </span>
    </div>

    <div class="search-parameters-container">
      <b>Score Cutoff:</b>

      <span>
        {{
          parameterDataModel.score ??
            ViewEventReportComponent.defaultFilterText() | number : "1.1-1"
        }}
      </span>
    </div>

    <div class="search-parameters-container">
      <b>Events:</b>

      <span *ngIf="tags | async as reportEvents; else noTagsTemplate">
        <ng-container *ngFor="let item of reportEvents; let last = last">
          <a [href]="item.viewUrl">
            {{ item.text }}
          </a>
          <ng-container *ngIf="!last">,</ng-container>
        </ng-container>
      </span>

      <ng-template #noTagsTemplate> (not specified) </ng-template>

      <span *ngIf="!parameterDataModel.events"></span>
    </div>
  </div>
</section>

<section>
  <h3>Summary</h3>

  <div class="reportOverview">
    <div class="alert alert-warning p-3 my-3">
      <b>
        General warning about different recognisers, 'interpret with cation and
        validate' etc; qualifiers about performance in different regions, etc
      </b>
    </div>

    <div class="d-flex">
      <div class="w-25">
        <!-- TODO: Fetching these values. This will most likely require a 3rd party API -->
        <h4 class="py-1">Native Species: 5</h4>
        <h4 class="py-1">Non-native: 3</h4>
        <h4 class="py-1">Invasive: 3</h4>
      </div>

      <baw-site-map
        class="site-map"
        [sites]="selectedSites() | async"
      ></baw-site-map>
    </div>

    <baw-chart
      class="coverageGraph"
      [title]="'Audio Recording Coverage'"
      [spec]="coveragePlotSchema"
      [data]="report.graphs.coverageData.recordingCoverage"
    ></baw-chart>

    <baw-chart
      name="analysisCoverageGraph"
      class="coverageGraph"
      [title]="'Analysis Coverage'"
      [spec]="coveragePlotSchema"
      [data]="report.graphs.coverageData.analysisCoverage"
    ></baw-chart>

    <p>
      For the requested {{ totalSearchSpan() | toRelative }}, we've analysed 90%
    </p>
  </div>
</section>

<section>
  <h3>Events Table</h3>

  <div class="events-table">
    <div class="py-4">
      <b
        >Total number of {{ parameterDataModel.bucketSize | titlecase }}s
        analysed:
      </b>
      {{ report.statistics?.countOfRecordingsAnalyzed }}
      {{ parameterDataModel.bucketSize | titlecase }}s <br />
      <strong>
        {{ audioCoverageOverSpan() | toRelative }}
      </strong>
      of recordings were found within the requested
      <strong>
        {{ totalSearchSpan() | toRelative }}
      </strong>

      <a name="downloadEventsLink" [href]="eventDownloadUrl">
        <fa-icon
          [icon]="['fas', 'file-arrow-down']"
          [ngbTooltip]="'Download this table'"
        ></fa-icon>
      </a>
    </div>

    <table class="table">
      <tr class="row">
        <th class="col fw-bold">Events</th>
        <th class="col fw-bold">Recogniser</th>
        <th class="col fw-bold">Detections</th>
        <th class="col fw-bold">
          % of {{ parameterDataModel.bucketSize | titlecase }}s with Detections
        </th>
        <th class="col fw-bold">
          % of {{ parameterDataModel.bucketSize | titlecase }}s with Rain
        </th>
        <th class="col fw-bold border">Confidence Plot</th>
      </tr>

      <ng-container *ngFor="let item of report.eventGroups">
        <tr class="row">
          <td class="col">
            <a [href]="(getTag(item.tagId) | async).viewUrl">
              {{ (getTag(item.tagId) | async).text }}
            </a>
          </td>
          <td class="col">
            <a [href]="(getProvenance(item.provenanceId) | async).viewUrl">
              {{ (getProvenance(item.provenanceId) | async).name }}
            </a>
          </td>
          <td class="col">{{ item.detections | number }}</td>
          <td class="col">
            {{ item.bucketsWithDetections | percent }}
          </td>
          <td class="col">{{ bucketsWithRain(item) | percent }}</td>
          <td class="col">
            <baw-chart
              class="embedded-figure"
              [spec]="confidencePlotSchema"
              [data]="item.score.histogram"
            ></baw-chart>

            <small class="m-1 text-muted"
              >x̄: {{ item.score.mean | number : "1.2-2" }}</small
            >
            <small class="m-1 text-muted"
              >σ: {{ item.score.standardDeviation | number : "1.2-2" }}</small
            >
          </td>
        </tr>
      </ng-container>
    </table>
  </div>
</section>

<section>
  <h3>Charts</h3>

  <div class="alert alert-info p-3 my-3">
    Some kind of text to put these figures into context.
  </div>

  <div
    class="my-1"
    [class.hide-in-print]="accumulationCurveCollapsed"
    *ngIf="report.graphs?.accumulationData"
  >
    <h4>
      Species Accumulation Curve

      <a [href]="eventDownloadUrl">
        <fa-icon
          [icon]="['fas', 'file-arrow-down']"
          [ngbTooltip]="'Download this graphs data'"
        ></fa-icon>
      </a>

      <button
        class="toggle-graph-button btn btn-secondary btn-sm"
        (click)="accumulationCurveCollapsed = !accumulationCurveCollapsed"
      >
        <fa-icon
          [icon]="['fas', accumulationCurveCollapsed ? 'maximize' : 'minimize']"
        ></fa-icon>
      </button>
    </h4>
    <div [ngbCollapse]="accumulationCurveCollapsed">
      <baw-chart
        class="large-embedded-figure"
        [spec]="speciesAccumulationCurveSchema"
        [data]="report.graphs?.accumulationData"
      ></baw-chart>
    </div>
  </div>

  <div
    class="my-1"
    [class.hide-in-print]="compositionCurveCollapsed"
    *ngIf="report.graphs?.speciesCompositionData"
  >
    <h4>
      Species Composition

      <a [href]="eventDownloadUrl">
        <fa-icon
          [icon]="['fas', 'file-arrow-down']"
          [ngbTooltip]="'Download this graphs data'"
        ></fa-icon>
      </a>

      <button
        class="toggle-graph-button btn btn-secondary btn-sm"
        (click)="compositionCurveCollapsed = !compositionCurveCollapsed"
      >
        <fa-icon
          [icon]="['fas', compositionCurveCollapsed ? 'maximize' : 'minimize']"
        ></fa-icon>
      </button>
    </h4>
    <div [ngbCollapse]="compositionCurveCollapsed">
      <baw-chart
        class="large-embedded-figure"
        [spec]="speciesCompositionCurveSchema"
        [data]="report.graphs?.speciesCompositionData"
      ></baw-chart>
    </div>
  </div>

  <div class="my-1" [class.hide-in-print]="falseColorSpectrogramsCollapsed">
    <h4>
      False colour spectrogram(s)

      <a [href]="eventDownloadUrl">
        <fa-icon
          [icon]="['fas', 'file-arrow-down']"
          [ngbTooltip]="'Download false colour spectrogram(s)'"
        ></fa-icon>
      </a>

      <button
        class="toggle-graph-button btn btn-secondary btn-sm"
        (click)="
          falseColorSpectrogramsCollapsed = !falseColorSpectrogramsCollapsed
        "
      >
        <fa-icon
          [icon]="[
            'fas',
            falseColorSpectrogramsCollapsed ? 'maximize' : 'minimize'
          ]"
        ></fa-icon>
      </button>
    </h4>
    <div [ngbCollapse]="falseColorSpectrogramsCollapsed">
      <div class="large-embedded-figure p-1">False colour spectrogram(s)</div>
    </div>
  </div>
</section>
