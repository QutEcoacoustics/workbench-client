<h2>
  Acoustic Event Summary Report

  <a id="print-button" class="ms-3" (click)="printPage()">
    <fa-icon [icon]="['fas', 'print']"></fa-icon>
  </a>
</h2>

<div class="generatedByLabel">
  <i>
    Generated by {{ currentUser.userName }}
    {{ report.generatedDate ?? DateTime.now() | dateTime }}
  </i>
</div>

<section>
  <h3>Search Parameters</h3>

  <div class="search-parameters">
    <div class="search-parameters-container">
      <b>Sites:</b>

      <span *ngIf="regions | async as reportRegions">
        <ng-container *ngFor="let item of reportRegions; let last = last">
          {{ item.name }}
          <ng-container *ngIf="!last">,</ng-container>
        </ng-container>
      </span>

      <span *ngIf="!parameterDataModel.sites">(not specified)</span>
    </div>

    <div class="search-parameters-container">
      <b>Points:</b>

      <span *ngIf="sites | async as reportSites">
        <ng-container *ngFor="let item of reportSites; let last = last">
          {{ item.name }}
          <ng-container *ngIf="!last">,</ng-container>
        </ng-container>
      </span>

      <span *ngIf="!parameterDataModel.points">(not specified)</span>
    </div>

    <div class="search-parameters-container">
      <b>Times:</b>

      <span
        *ngIf="
          parameterDataModel.timeStartedAfter ||
          parameterDataModel.timeFinishedBefore
        "
      >
        {{ parameterDataModel.timeStartedAfter | time }} –
        {{ parameterDataModel.timeFinishedBefore | time }}
      </span>

      <span
        *ngIf="
          !parameterDataModel.timeStartedAfter &&
          !parameterDataModel.timeFinishedBefore
        "
      >
        (not specified)
      </span>
    </div>

    <div class="search-parameters-container">
      <b>Date Range:</b>

      <span
        *ngIf="
          parameterDataModel.dateStartedAfter ||
          parameterDataModel.dateFinishedBefore
        "
      >
        {{ parameterDataModel.dateStartedAfter | dateTime }} –
        {{ parameterDataModel.dateFinishedBefore | dateTime }}
      </span>

      <span
        *ngIf="
          !parameterDataModel.dateStartedAfter &&
          !parameterDataModel.dateFinishedBefore
        "
      >
        (not specified)
      </span>
    </div>

    <div class="search-parameters-container">
      <b>Duration:</b> {{ parameterDataModel.bucketSize | titlecase }}
    </div>

    <div class="search-parameters-container">
      <b>Recognisers:</b>

      <span *ngIf="parameterDataModel.provenances">
        <ng-container *ngFor="let provenance of parameterDataModel.provenances; let last = last">
          {{ (getProvenance(provenance) | async).name }}
          <ng-container *ngIf="!last">,</ng-container>
        </ng-container>
      </span>

      <span *ngIf="!parameterDataModel.provenances"> (not specified) </span>
    </div>

    <div class="search-parameters-container">
      <b>Score Cutoff:</b>

      <span>
        {{
          parameterDataModel.score ??
            ViewEventReportComponent.defaultFilterText() | number : "1.1-1"
        }}
      </span>
    </div>

    <div class="search-parameters-container">
      <b>Events:</b>

      <span *ngIf="tags | async as reportEvents">
        <ng-container *ngFor="let item of reportEvents; let last = last">
          {{ item.text }}
          <ng-container *ngIf="!last">,</ng-container>
        </ng-container>
      </span>

      <span *ngIf="!parameterDataModel.events"></span>
    </div>
  </div>
</section>

<section>
  <h3>Summary</h3>

  <div class="reportOverview">
    <div class="alert alert-warning p-3 my-3">
      <b>
        General warning about different recognisers, 'interpret with cation and
        validate' etc; qualifiers about performance in different regions, etc
      </b>
    </div>

    <div class="container">
      <div class="row">
        <div class="col">
          <div>
            <!-- TODO: Fetching these values. This will most likely require a 3rd party API -->
            <h4 class="py-1 w-25">Native Species: 5</h4>
            <h4 class="py-1 w-25">Non-native: 3</h4>
            <h4 class="py-1 w-25">Invasive: 3</h4>
          </div>
        </div>

        <div class="col">
          <div name="siteMap">
            <baw-site-map
              class="site-map"
              [project]="project"
              [region]="region"
              [sites]="sites | async"
            ></baw-site-map>
          </div>
        </div>
      </div>
    </div>

    <label for="audioCoverageGraph"><b>Audio Recording Coverage</b></label>
    <baw-chart
      name="audioCoverageGraph"
      class="coverageGraph"
      [spec]="coveragePlotSchema"
      [data]="report.graphs.coverageData.recordingCoverage"
    ></baw-chart>

    <label for="analysisCoverageGraph"><b>Analysis Coverage</b></label>
    <baw-chart
      name="analysisCoverageGraph"
      class="coverageGraph"
      [spec]="coveragePlotSchema"
      [data]="report.graphs.coverageData.analysisCoverage"
    ></baw-chart>
  </div>
</section>

<section>
  <h3>Events Table</h3>

  <div class="events-table">
    <div class="py-4">
      <b
        >Total number of {{ parameterDataModel.bucketSize | titlecase }}s
        analysed:
      </b>
      {{ report.statistics?.countOfRecordingsAnalyzed }}
      {{ parameterDataModel.bucketSize | titlecase }}s <br />
      <strong>
        {{ audioCoverageOverSpan() | toRelative }}
      </strong>
      of recordings were found within the requested
      <strong>
        {{ totalSearchSpan() | toRelative }}
      </strong>
      <a
        name="downloadEventsLink"
        class="link-primary"
        href="{{ eventDownloadUrl }}"
        >download this table</a
      >.
    </div>

    <table class="table">
      <tr class="row">
        <th class="col border py-1 fw-bold">Events</th>
        <th class="col border py-1 fw-bold">Recogniser</th>
        <th class="col border py-1 fw-bold"># Detections</th>
        <th class="col border py-1 fw-bold">
          Detection {{ parameterDataModel.bucketSize | titlecase }}s
        </th>
        <th class="col border py-1 fw-bold">
          {{ parameterDataModel.bucketSize | titlecase }}s with Rain
        </th>
        <th class="col border py-1 fw-bold border">Confidence Plot</th>
      </tr>

      <ng-container *ngFor="let item of report.eventGroups">
        <tr class="row">
          <td class="col border py-1">tag name</td>
          <td class="col border py-1">{{ getProvenance(item.provenanceId) | async }}</td>
          <td class="col border py-1">{{ item.detections | number }}</td>
          <td class="col border py-1">
            {{ item.bucketsWithDetections | number }}
          </td>
          <td class="col border py-1">{{ bucketsWithRain(item) | number }}</td>
          <td class="col border py-1">
            <baw-chart
              class="embedded-figure"
              [spec]="confidencePlotSchema"
              [data]="item.score.histogram"
              [options]="{ actions: false }"
            ></baw-chart>

            <small class="m-1 text-muted"
              >x̄: {{ item.score.mean | number : "1.2-2" }}</small
            >
            <small class="m-1 text-muted"
              >σ: {{ item.score.standardDeviation | number : "1.2-2" }}</small
            >
          </td>
        </tr>
      </ng-container>
    </table>
  </div>
</section>

<section>
  <h3>Graphs</h3>

  <div class="alert alert-info p-3 my-3">
    Some kind of text to put these figures into context.
  </div>

  <div class="my-1">
    <h4>
      Site Map

      <button
        class="toggle-graph-button btn btn-secondary btn-sm"
        (click)="siteMapCollapsed = !siteMapCollapsed"
        aria-controls="collapseExample"
        aria-expanded="false"
      >
        {{ siteMapCollapsed ? "Show" : "Hide" }}
      </button>
    </h4>
    <div id="siteMapContainer" [ngbCollapse]="siteMapCollapsed">
      <div class="large-embedded-figure p-1">
        <baw-site-map
          class="w-100 h-100"
          [project]="project"
          [region]="region"
          [sites]="sites | async"
        ></baw-site-map>
      </div>
    </div>
  </div>

  <div class="my-1" *ngIf="report.graphs?.accumulationData">
    <h4>
      Species Accumulation Curve

      <button
        class="toggle-graph-button btn btn-secondary btn-sm"
        (click)="accumulationCurveCollapsed = !accumulationCurveCollapsed"
        aria-controls="collapseExample"
        aria-expanded="false"
      >
        {{ accumulationCurveCollapsed ? "Show" : "Hide" }}
      </button>
    </h4>
    <div [ngbCollapse]="accumulationCurveCollapsed">
      <baw-chart
        class="large-embedded-figure"
        [spec]="speciesAccumulationCurveSchema"
        [data]="report.graphs?.accumulationData"
      ></baw-chart>
    </div>
  </div>

  <div class="my-1" *ngIf="report.graphs?.speciesCompositionData">
    <h4>
      Species Composition

      <button
        class="toggle-graph-button btn btn-secondary btn-sm"
        (click)="compositionCurveCollapsed = !compositionCurveCollapsed"
        aria-controls="collapseExample"
        aria-expanded="false"
      >
        {{ compositionCurveCollapsed ? "Show" : "Hide" }}
      </button>
    </h4>
    <div [ngbCollapse]="compositionCurveCollapsed">
      <baw-chart
        class="large-embedded-figure"
        [spec]="speciesCompositionCurveSchema"
        [data]="report.graphs?.speciesCompositionData"
      ></baw-chart>
    </div>
  </div>

  <div class="my-1">
    <h4>
      False colour spectrogram(s)

      <button
        class="toggle-graph-button btn btn-secondary btn-sm"
        (click)="falseColorSpectrogramsCollapsed = !falseColorSpectrogramsCollapsed"
        aria-controls="collapseExample"
        aria-expanded="false"
      >
        {{ falseColorSpectrogramsCollapsed ? "Show" : "Hide" }}
      </button>
    </h4>
    <div [ngbCollapse]="falseColorSpectrogramsCollapsed">
      <div class="large-embedded-figure p-1">False colour spectrogram(s)</div>
    </div>
  </div>
</section>
