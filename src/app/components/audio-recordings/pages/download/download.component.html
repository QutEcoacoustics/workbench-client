<h1>Batch Download Audio Recordings</h1>

<!-- Warn users about limitations of time of day filter -->
<baw-sites-without-timezones
  [site]="site"
  [region]="region"
  [project]="project"
></baw-sites-without-timezones>

<form #form class="mb-3">
  <!-- Project -->
  <div *ngIf="project" class="mb-3">
    <label id="project-label" for="project" class="form-label">Project</label>
    <input
      readonly
      id="project"
      name="project"
      class="form-control-plaintext"
      [ngModel]="project.name"
    />
  </div>

  <!-- Region -->
  <div *ngIf="region" class="mb-3">
    <label id="region-label" for="region" class="form-label">Site</label>
    <input
      readonly
      id="region"
      name="region"
      class="form-control-plaintext"
      [ngModel]="region.name"
    />
  </div>

  <!-- Site -->
  <div *ngIf="site" class="mb-3">
    <label id="site-label" for="site" class="form-label">{{
      region ? "Point" : "Site"
    }}</label>
    <input
      readonly
      id="site"
      name="site"
      class="form-control-plaintext"
      [ngModel]="site.name"
    />
  </div>

  <!-- Toggle filtering by date -->
  <div class="form-check">
    <input
      id="day-filtering"
      name="dayFiltering"
      type="checkbox"
      class="form-check-input"
      [(ngModel)]="model.dayFiltering"
    />

    <label class="form-check-label" for="day-filtering">Filter by date</label>

    <div class="form-text">Filter recordings over a date range</div>
  </div>

  <!-- Date filters -->
  <div
    id="day-range-filters-wrapper"
    #collapse="ngbCollapse"
    [ngbCollapse]="!model.dayFiltering"
  >
    <div class="card">
      <div class="card-body">
        <!-- Start date input -->
        <div class="mb-3">
          <label for="day-started-after" class="form-label"> Start date </label>
          <!-- TODO Replace with dates using yyyy-mm-dd format -->
          <input
            id="day-started-after"
            name="dayStartedAfter"
            type="date"
            class="form-control"
            [(ngModel)]="model.dayStartedAfter"
            useValueAsDate
          />

          <div class="form-text">
            <strong
              >The UTC (+00:00) time zone is used for all date
              filtering.</strong
            >
            If you're unsure if your data will be included in a filter, expand
            your date range by one-day in either direction.
          </div>
        </div>

        <!-- End date input -->
        <div>
          <label for="day-finished-before" class="form-label"> End date </label>
          <!-- TODO Replace with dates using yyyy-mm-dd format -->
          <input
            id="day-finished-before"
            name="dayFinishedBefore"
            type="date"
            class="form-control"
            [(ngModel)]="model.dayFinishedBefore"
            useValueAsDate
          />

          <div class="form-text">
            <strong
              >The UTC (+00:00) time zone is used for all date
              filtering.</strong
            >
            If you're unsure if your data will be included in a filter, expand
            your date range by one-day in either direction.
          </div>

          <!-- TODO Warning message if end date is before start date -->
        </div>
      </div>
    </div>
  </div>

  <!-- Toggle filtering by time of day -->
  <div class="form-check">
    <input
      id="tod-filtering"
      name="todFiltering"
      type="checkbox"
      class="form-check-input"
      [(ngModel)]="model.todFiltering"
    />

    <label class="form-check-label" for="tod-filtering">
      Filter by time of day
    </label>

    <div class="form-text">
      Filter recordings by the time of day they were recorded. If any part of a
      recording overlaps these limits, then it will be included.
    </div>
  </div>

  <!-- Time of day filters -->
  <div
    id="tod-filters-wrapper"
    #collapse="ngbCollapse"
    [ngbCollapse]="!model.todFiltering"
  >
    <div class="card">
      <div class="card-body">
        <!-- Ignore daylight savings checkbox -->
        <div class="form-check mb-3">
          <input
            id="tod-ignore-dst"
            name="todIgnoreDst"
            type="checkbox"
            class="form-check-input"
            [disabled]="!model.todFiltering"
            [(ngModel)]="model.todIgnoreDst"
          />

          <label class="form-check-label" for="tod-ignore-dst">
            Ignore day light savings (DST)
          </label>

          <div class="form-text">
            Real world events, like dawn chorus, or the vocalization of fauna
            are not affected by daylight savings time. Ignoring DST is advised
            to ensure audio is filtered consistently. If any recordings occur
            during a DST period, the base offset, that is the time it would be
            if DST were not in effect, will be used.
          </div>
        </div>

        <div class="mb-3">
          <div class="input-group">
            <!-- Start time input -->
            <span class="input-group-text">Start Time</span>
            <input
              id="tod-started-after"
              name="todStartedAfter"
              type="time"
              class="form-control"
              [class.is-invalid]="errors.todBoundaryError"
              [disabled]="!model.todFiltering"
              [(ngModel)]="todStartedAfter"
            />
            <!-- End time input -->
            <span class="input-group-text">End Time</span>
            <input
              id="tod-finished-before"
              name="todFinishedBefore"
              type="time"
              class="form-control"
              [class.is-invalid]="errors.todBoundaryError"
              [disabled]="!model.todFiltering"
              [(ngModel)]="todFinishedBefore"
            />
          </div>

          <div *ngIf="errors.todBoundaryError" class="form-error">
            Time of day filtering does not currently support filtering past a
            day boundary. Please adjust your request so that the start time is
            before the end time.
          </div>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- TODO Preview audio recordings which will be downloaded by this request -->
<baw-download-table [recordings$]="recordings$"></baw-download-table>

<div class="clearfix">
  <a
    id="download-script"
    class="btn btn-primary float-end mt-3"
    [class.disabled]="invalidForm(errors)"
    [href]="href"
  >
    Download Script
  </a>
</div>

<!-- TODO Extract to CMS? -->
<section>
  <h2>Instructions</h2>

  <p>
    The above form will guide you to downloading a PowerShell script which can
    be used to download the audio files in batches. If you need more help please
    <a [strongRoute]="contactUs.route">{{ contactUs.label }}.</a>
  </p>

  <h3>1. Install PowerShell 7+</h3>

  <p>
    If you do not already have PowerShell 7 or newer installed on your machine,
    <a
      href="https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell?view=powershell-7.2"
    >
      download here</a
    >.
    <strong>
      Having the latest version of Windows does not mean you have PowerShell 7.
    </strong>
  </p>

  <!-- TODO Show users how with asciicast -->

  <h3>2. Move the downloader script</h3>

  <p>
    Find the file you have downloaded (likely from the downloads folder) and
    move it to the location where you want audio files to be downloaded. For
    example, if you wanted to download files to your external hard drive, move
    the script to your external hard drive.
  </p>

  <p>
    We suggest not using a cloud folder, such as google drive, as the downloaded
    recordings may use a lot of storage space.
  </p>

  <h3>3. Unblock the downloader script</h3>

  <p></p>

  <ul>
    <li>
      If you are on Windows
      <a href="https://www.thewindowsclub.com/fix-windows-blocked-access-file">
        unblock the file</a
      >. If you don't see the option to unblock the file, skip this step.
    </li>
    <li>
      If you are on Linux/MacOS, update the permissions of the file using:
      <code>chmod +x "download_audio_files.ps1"</code>. You can open the folder
      containing the file in a terminal following
      <a
        href="https://www.groovypost.com/howto/open-command-window-terminal-window-specific-folder-windows-mac-linux/"
        >this guide</a
      >
    </li>
  </ul>

  <h3>4. Open a terminal</h3>

  <ul>
    <li>
      If you are on Windows,
      <a
        href="https://www.groovypost.com/howto/open-command-window-terminal-window-specific-folder-windows-mac-linux/"
        >open the folder containing the script in a PowerShell shell</a
      >
    </li>
    <li>
      If you are on MacOS,
      <a
        href="https://www.handlebar-online.com/popular-questions/how-do-i-open-a-terminal-in-a-specific-folder-mac/"
      >
        open the folder containing the script in a terminal</a
      >
    </li>
    <li>
      If you are on Linux, instructions should be similar to MacOS, however you
      may need to find instructions relevant to your distro/file manager.
    </li>
  </ul>

  <p>
    You can then open the PowerShell shell by running <code>pwsh</code> inside
    the terminal you just opened
  </p>

  <h3>5. Get an authentication token</h3>

  <p>
    Each time you want to run this script, you will need to supply an
    authentication token (auth token).
    <strong class="text-danger"> Treat this code like your password.</strong>
    You can find the auth token in your
    <a [strongRoute]="profile.route">{{ profile.label }}</a> page, under the
    "Authentication Token" section. Copy the auth token, and keep it for the
    next step.
  </p>

  <!-- TODO Show users how with asciicast -->

  <h3>6. Run the script</h3>

  <p>
    Copy and paste the following command into your PowerShell session. Ensure
    you replace INSERT_AUTH_TOKEN_HERE with your auth token.
  </p>

  <p>
    <code>
      ./download_audio_files.ps1 -auth_token "INSERT_AUTH_TOKEN_HERE"
    </code>
  </p>

  <p>Press <kbd>enter</kbd> to run the script.</p>
</section>
