<h1>Batch Download Audio Recordings</h1>

<!-- Warn users about limitations of time of day filter -->
<baw-sites-without-timezones
  [site]="site"
  [region]="region"
  [project]="project"
></baw-sites-without-timezones>

<form #form>
  <!-- Project -->
  <div *ngIf="project" class="mb-3">
    <label id="project-label" for="project" class="form-label">Project</label>
    <input
      readonly
      id="project"
      name="project"
      class="form-control-plaintext"
      [ngModel]="project.name"
    />
  </div>

  <!-- Region -->
  <div *ngIf="region" class="mb-3">
    <label id="region-label" for="region" class="form-label">Site</label>
    <input
      readonly
      id="region"
      name="region"
      class="form-control-plaintext"
      [ngModel]="region.name"
    />
  </div>

  <!-- Site -->
  <div *ngIf="site" class="mb-3">
    <label id="site-label" for="site" class="form-label">{{
      region ? "Point" : "Site"
    }}</label>
    <input
      readonly
      id="site"
      name="site"
      class="form-control-plaintext"
      [ngModel]="site.name"
    />
  </div>

  <!-- Start Date -->
  <div class="mb-3">
    <label for="startDate" class="form-label">
      Date recording started after
    </label>
    <!-- TODO Replace with dates using yyyy-mm-dd format -->
    <input
      id="started-after"
      name="startedAfter"
      type="date"
      class="form-control"
      [(ngModel)]="model.startedAfter"
      useValueAsDate
    />

    <div class="form-text">
      <strong
        >The UTC (+00:00) time zone is used for all date filtering.</strong
      >
      If you're unsure if your data will be included in a filter, expand your
      date range by one-day in either direction.
    </div>
  </div>

  <!-- End Date -->
  <div class="mb-3">
    <label for="endDate" class="form-label">
      Date recording ended before
    </label>
    <!-- TODO Replace with dates using yyyy-mm-dd format -->
    <input
      id="finished-before"
      name="finishedBefore"
      type="date"
      class="form-control"
      [(ngModel)]="model.finishedBefore"
      useValueAsDate
    />

    <div class="form-text">
      <strong
        >The UTC (+00:00) time zone is used for all date filtering.</strong
      >
      If you're unsure if your data will be included in a filter, expand your
      date range by one-day in either direction.
    </div>

    <!-- TODO Warning message if end date is before start date -->
  </div>

  <!-- Time of Day Selector -->

  <label for="timeOfDay" class="form-label">Time of Day Filter</label>

  <div class="form-check mb-3">
    <input
      id="tod-filtering"
      name="todEnabled"
      type="checkbox"
      class="form-check-input"
      [(ngModel)]="model.todEnabled"
    />

    <label class="form-check-label" for="tod-filtering">
      Enable filtering by time of day
    </label>
  </div>

  <div #collapse="ngbCollapse" [ngbCollapse]="!model.todEnabled">
    <div class="form-check mb-3">
      <input
        id="tod-ignore-dst"
        name="todIgnoreDst"
        type="checkbox"
        class="form-check-input"
        [disabled]="!model.todEnabled"
        [(ngModel)]="model.todIgnoreDst"
      />

      <label class="form-check-label" for="tod-ignore-dst">
        Ignore day light savings (DST)
      </label>

      <div class="form-text">
        Real world events, like dawn chorus, or the vocalization of fauna are
        not affected by daylight savings time. Ignoring DST is advised to ensure
        audio is filtered consistently. If any recordings occur during a DST
        period, the base offset, that is the time it would be if DST were not in
        effect, will be used.
      </div>
    </div>

    <div class="mb-3">
      <div class="input-group">
        <span class="input-group-text">Start Time</span>
        <input
          id="tod-started-after"
          name="todStartedAfter"
          type="time"
          class="form-control"
          [class.is-invalid]="errors.todBoundaryError"
          [disabled]="!model.todEnabled"
          [(ngModel)]="todStartedAfter"
        />
        <span class="input-group-text">End Time</span>
        <input
          id="tod-finished-before"
          name="todFinishedBefore"
          type="time"
          class="form-control"
          [class.is-invalid]="errors.todBoundaryError"
          [disabled]="!model.todEnabled"
          [(ngModel)]="todFinishedBefore"
        />
      </div>

      <div class="form-text">
        Filter recordings by the time of day they were recorded. If any part of
        a recording overlaps these limits, then it will be included.
      </div>

      <div *ngIf="errors.todBoundaryError" class="form-error">
        Time of day filtering does not currently support filtering past a day
        boundary. Please adjust your request so that the start time is before
        the end time.
      </div>
    </div>
  </div>
</form>

<baw-download-table [recordings$]="recordings$"></baw-download-table>

<div class="clearfix">
  <a
    class="btn btn-primary float-end mt-3"
    [class.disabled]="invalidForm(errors)"
    [href]="href"
    >Download Script</a
  >
</div>

<!-- TODO Preview audio recordings which will be downloaded by this request -->

<hr />

<!-- TODO Extract to CMS? -->
<section>
  <h2>Instructions</h2>

  <p>
    The above form will guide you to downloading a PowerShell script which can
    be used to download the audio files in batches. If you need more help please
    <a [strongRoute]="contactUs.route">{{ contactUs.label }}.</a>
  </p>

  <h3>1. Install PowerShell</h3>

  <p>
    If you do not already have PowerShell 7 or newer installed on your machine,
    read through
    <a
      href="https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell?view=powershell-7.2"
    >
      this guide.
    </a>
  </p>

  <!-- TODO Show users how with asciicast -->

  <h3>2. Move the downloader script</h3>

  <p>
    Find the file you have downloaded (likely from the downloads folder) and
    move it to the location where you want audio files to be downloaded.
  </p>

  <p>
    For example, if you wanted to download files to your external hard drive,
    move the script to your external hard drive.
  </p>

  <h3>3. Unblock the downloader script</h3>

  <ul>
    <li>
      If you are on Windows
      <a href="https://www.thewindowsclub.com/fix-windows-blocked-access-file"
        >unblock the file</a
      >
    </li>
    <li>
      If you are on Linux or MacOS, update the permissions of the file using
      <code>chmod +x "download_audio_files.ps1"</code>
    </li>
  </ul>

  <p>Depending on your personal settings,</p>

  <h3>4. Open a terminal</h3>

  <p>
    Next open PowerShell in the same folder as your script. In most operating
    systems the file manager has the option to open the current folder in a
    terminal. If that is not possible, you will need to copy the folder path,
    and use <code>cd "FOLDER_LOCATION_HERE"</code> to change to the correct
    directory.
  </p>

  <p>
    You can open a PowerShell shell by running <code>pwsh</code> inside a normal
    shell (like <code>cmd</code>/<code>bash</code>/<code>zsh</code>).
  </p>

  <h3>5. Get an authentication token</h3>

  <p>
    Each time you want to run this script, you will need to supply an
    authentication token (auth token).
    <strong class="text-danger"> Treat this code like your password.</strong>
    You can find the auth token in your
    <a [strongRoute]="profile.route">{{ profile.label }}</a> page, under the
    "Authentication Token" section. Copy the auth token, and keep it for the
    next step.
  </p>

  <!-- TODO Show users how with asciicast -->

  <h3>6. Run the script</h3>

  <p>
    Copy and paste the following command into your PowerShell session. Ensure
    you replace INSERT_AUTH_TOKEN_HERE with your auth token.
  </p>

  <p>
    <code>
      ./download_audio_files.ps1 -auth_token "INSERT_AUTH_TOKEN_HERE
    </code>
  </p>

  <p>Press <kbd>enter</kbd> to run the script.</p>
</section>
